seajs.use(["$","bootstrap","underscore"],function($,bootstrap,_){function queryPosSdl(mediaPlanId){var record=null,url="/adpublish/mediaPosition/search.do",data={mediaPlanId:mediaPlanId};$.ajax({url:url,type:"POST",async:!1,data:data,dateType:"JSON",success:function(a){record=a},error:function(){}}),adsData=null!=record&&""!=record?eval("("+record+")"):{}}function days(a){var b=LunarCalendar.solarCalendar(a.begin.year,a.begin.month,0),c=_.filter(b.monthData,function(b,c){return c>=a.begin.day-1});if(a.begin.month==a.end.month)c=_.filter(b.monthData,function(b,c){return c>=a.begin.day-1&&c<=a.end.day-1});else{var d=LunarCalendar.solarCalendar(a.end.year,a.end.month,0),e=_.filter(d.monthData,function(b,c){return c<=a.end.day-1});c=c.concat(e)}return c}function buildCal(a){var b=_.template($("#j-schedule").html()),c=days(a),d=_.filter(c,function(a){return c[0].month==a.month}),e=32*d.length-80;c[0].month==c[27].month&&(e=1e4),$(".header-table").html(b({cal:c,mgl:e})).data(a)}function insertAds(a){if(!$.isEmptyObject(a)){var b={},c={};for(var d in a)1==a[d].saleType?b[d]=a[d]:c[d]=a[d];refreshAndShowAds(b,1),refreshAndShowAds(c,2),_.each(adsData,function(a){updateDate(a)}),updateTotalCost()}}function refreshAndShowAds(a,b){if(!$.isEmptyObject(a)){var c=_.template($("#j-ads-list").html()),d=_.template($("#j-ads-total").html()),e=$(".header-table").data(e),f=days(e);$("#j-table1-"+b).html(c({cal:f,ads:a,type:b})),$("#j-table2-"+b).html(d({ads:a,type:b}))}}function updateTotalCost(){var a=$("#totalguidecost"),b=$("#totalpricecost"),c=$("[id^='guidecost_']"),d=$("[id^='totalcost_']"),e=0;c.each(function(){var a=parseFloat($(this).text());e+=a}),a.text(e.toFixed(2));var f=0;d.each(function(){var a=parseFloat($(this).text());f+=a}),b.text(f.toFixed(2)),$("#publishTotalMoney").val(e.toFixed(2)),$("#costTotalMoney").val(f.toFixed(2))}function updateDate(a,b){var c=$("#timeViewItem_"+a.aId),d="",e=0;_.each(a.date,function(a){"3"==a.status&&(d+="<div><span>"+moment(a.begin,"X").format("YYYY-MM-DD")+"</span> ~ <span>"+moment(a.end,"X").format("YYYY-MM-DD")+"</span></div>",e+=(a.end-a.begin)/86400+1)}),c.find(".td_partialDate").addClass("hasDate"),c.find(".td_partialDate .td_date").html(d),$("#days_"+a.aId).html(e),b&&insertAds(adsData),daysChange(a.aId)}function daysChange(a){calAndSetCostMoney(a),calAndSetPublishMoney(a),updateTotalCost();var b=$("#days_"+a).text();updateAdsData(a,"publishDays",b)}function calAndSetCostMoney(a){var b=$("#price_"+a),c=b.val(),d=$("#payMode_"+a),e=0;if(d.val()==CPM){var f=$("#quantity_"+a).val();e=parseFloat(c*f/1e3)}else if(d.val()==CPD){var g=$("#days_"+a).text();e=parseFloat(c*g)}else{var f=$("#quantity_"+a).val();e=parseFloat(c*f)}var h=parseFloat($("#totalcost_"+a).text());$("#totalcost_"+a).text(e.toFixed(2));var i=$("#saleType_"+a),j=$("#totalcost-"+i.val()),k=parseFloat(j.text()),l=(k-h+e).toFixed(2);j.text(l),calAndSetDiscount(a),updateAdsData(a,"salePrice",c),updateAdsData(a,"costTotalMoney",l)}function calAndSetDiscount(a){var b=$("#price_"+a),c=b.val();$discount=$("#discountRate_"+a),$realguide=$("#realguide_"+a);var d=parseFloat($("#realguide_"+a).text()),e=0;d&&0!=d&&(e=(100*c/d).toFixed(2)),$discount.text(e),updateAdsData(a,"discountRate",e)}function calAndSetPublishMoney(a){var b=$("#realguide_"+a),c=b.text(),d=$("#payMode_"+a),e=0;if(d.val()==CPD){var f=$("#days_"+a).text();e=parseFloat(c*f)}else{var g=$("#quantity_"+a).val();e=parseFloat(c*g/1e3)}var h=parseFloat($("#guidprice_"+a).text());$("#guidprice_"+a).text(e.toFixed(2));var i=$("#saleType_"+a),j=$("#guidecost-"+i.val()),k=parseFloat(j.text()),l=(k-h+e).toFixed(2);j.text(l),updateAdsData(a,"publishTotalMoney",l)}function insertDateInput(a){if(2!=a.status){var b=_.template($("#j-date-input").html()),c=$("#j-ad-date").find(".date-box-line").length;$("#j-ad-date").find("#j-add-date").parent().before(b({index:c,date:a}));var d={format:"yyyy-mm-dd",language:"zh-CN",startDate:new Date,autoclose:!0},e=function(a,b){var c=$(a),e=$(b);c.datepicker(d).on("changeDate",function(a){e.datepicker("setStartDate",new Date(moment(a.date).add(1,"days").format()))}),e.datepicker(d).on("changeDate",function(a){c.datepicker("setEndDate",new Date(moment(a.date).subtract(1,"days").format()))})};e("#j-begin-date-"+c,"#j-end-date-"+c)}}function useTimestampUpdateDate(){_.each(adsData,function(a){_.each(a.date,function(a){a.beginDate=moment(a.begin,"X").format("YYYY-MM-DD"),a.endDate=moment(a.end,"X").format("YYYY-MM-DD")})})}function updateAdsData(a,b,c){adsData["a"+a][b]=c}function getNewSelectPosData(a){var b="/adpublish/mediaPosition/getNewSelectPosData.do",c=null,d={selectPosData:a};return $.ajax({url:b,type:"POST",async:!1,data:d,dataType:"JSON",success:function(a){c=a},error:function(){alert("系统错误!")}}),c}function queryPosStatusData(a,b){var c="/adpublish/mediaPosition/getPosStatusData.do",d=null,e={};_.each(adsData,function(a){var b={mediaPositionId:a.mediaPositionId,aId:a.aId};e["a"+a.aId]=b}),useTimestampUpdateDate();var f={jsonData:JSON.stringify(e),mediaPlanId:eqInMediaPlanId,beginDate:a,endDate:b};$.ajax({url:c,type:"POST",async:!1,data:f,dataType:"JSON",success:function(a){d=a},error:function(){alert("系统错误!")}}),d&&null!=d&&_.each(d,function(a){adsData["a"+a.aId].status=a.status})}window.adsData={},window.eqInMediaPlanId=0,window.initCalData=function(a){eqInMediaPlanId=a,queryPosSdl(a),insertAds(adsData)};var oTimeOption={format:"yyyy-mm-dd",language:"zh-CN",autoclose:!0},beginday=moment().add(1,"days"),endday=moment().add(28,"days");$("#j-view-date").datepicker(oTimeOption).datepicker("update",beginday.format("YYYY")+"-"+beginday.format("MM")+"-"+beginday.format("DD")),$("#j-view-date").on("changeDate",function(a){var b=moment(a.date),c=moment(a.date).add(27,"days");buildCal({begin:{year:b.format("YYYY"),month:b.format("M"),day:b.format("D")},end:{year:c.format("YYYY"),month:c.format("M"),day:c.format("D")}}),insertAds(adsData)}),buildCal({begin:{year:beginday.format("YYYY"),month:beginday.format("M"),day:beginday.format("D")},end:{year:endday.format("YYYY"),month:endday.format("M"),day:endday.format("D")}}),$(".btn-date").on("click",function(){var a=$(".header-table").data(),b=$(this),c=moment(a.begin.year+"-"+a.begin.month+"-"+a.begin.day,"YYYY-M-D");b.hasClass("nextDay")?c.add(1,"days"):b.hasClass("nextMonth")?c.add(1,"months"):b.hasClass("prevDay")?c.subtract(1,"days"):b.hasClass("prevMonth")&&c.subtract(1,"months");var d=moment(c.format("YYYY")+"-"+c.format("M")+"-"+c.format("D"),"YYYY-M-D");d.add(27,"days"),buildCal({begin:{year:c.format("YYYY"),month:c.format("M"),day:c.format("D")},end:{year:d.format("YYYY"),month:d.format("M"),day:d.format("D")}}),queryPosStatusData(moment(c,"X").format("YYYY-MM-DD"),moment(d,"X").format("YYYY-MM-DD")),insertAds(adsData)}),$(".ads-date").on("click",".st_free, .st_half",function(){if(!$(this).hasClass("not-allowed")){var a=$(this).find(".com_cb");a.hasClass("st3")||a.hasClass("st2")?a.removeClass("st2").removeClass("st3").addClass("st1").trigger({type:"change.status",cls:"st1",aId:$(this).parent().data("id")}):a.hasClass("st1")&&("1"==a.data("clash")?a.removeClass("st1").addClass("st2").trigger({type:"change.status",cls:"st3",aId:$(this).parent().data("id")}):a.removeClass("st1").addClass("st3").trigger({type:"change.status",cls:"st3",aId:$(this).parent().data("id")}))}}).on("mouseover",".adspace_title",function(){$(this).find(".icon_action").show()}).on("mouseout",".adspace_title",function(){$(this).find(".icon_action").hide()}).on("click",".icon_action",function(){var a=$(this),b=a.closest("tr").data("id"),c=$("#dateViewItem_"+b+", #timeViewItem_"+b);if(a.hasClass("icon_action_delete")){var d=$("#dateViewItem_"+b+" .tdheader");if(d.length)d.attr("rowspan",d.attr("rowspan")-1),c.next().prepend(d);else{var e=c.prevAll();d=$($(".date-view-item")[0]).find(".tdheader"),e.find(".tdheader").attr("rowspan",d.attr("rowspan")-1)}c.remove(),delete adsData["a"+b],console.log(adsData);var f=c.data("type"),g=$(".j-ad-item-"+f);0==g.length&&$("#total-"+f).html('<td class="tdheader">'+(1==f?"售卖":"配送")+'</td><td colspan="10" class="text-left">无</td>')}else{var h=c.find(".st_free .com_cb,.st_half .com_cb");h.hasClass("st2")||h.hasClass("st3")?h.removeClass("st2").removeClass("st3").addClass("st1").trigger({type:"change.status",cls:"st1",aId:c.data("id")}):h.hasClass("st1")&&h.removeClass("st1").addClass("st3").trigger({type:"change.status",cls:"st3",aId:c.data("id")}),_.each(h,function(a){var b=$(a);b.hasClass("st3")&&"1"==b.data("clash")&&b.removeClass("st3").addClass("st2")})}}),$(".date-view").on("change.status",".com_cb",function(a){var b=$(a.target),c=b.data("date"),d=c-86400,e=parseInt(c)+86400,f=adsData["a"+a.aId];if("st3"==a.cls){var g=0,h=[];if(_.each(f.date,function(a,b){"3"==a.status&&(a.end==d?(a.end=c,h.push(b),g++):a.begin==e&&(a.begin=c,h.push(b),g++))}),0==g&&f.date.push({status:3,begin:c,end:c}),h.length>1){var i=f.date[h[0]],j=f.date[h[1]];i.begin==j.end?(j.end=i.end,f.date.splice(h[0],1)):(i.end=j.end,f.date.splice(h[1],1))}}else"st1"==a.cls&&_.each(f.date,function(a,b){c==a.begin&&c==a.end?f.date.splice(b,1):c==a.begin?a.begin=e:c==a.end?a.end=d:c>a.begin&&c<a.end&&(f.date.push({status:3,begin:e,end:a.end}),a.end=d)});updateDate(f)}),$("#j-table2-1,#j-table2-2").on("mouseover",".hasDate",function(){$(this).find(".icon_modifyDate").show()}).on("mouseout",".hasDate",function(){$(this).find(".icon_modifyDate").hide()}),window.unitchange=function(a,b){var c=$(a),d=c.val(),e=$("#timeViewItem_"+b);e.find(".j-unit-title").html($(a).text());var f=$("#payMode_"+b);f.val(d),d==CPD?($("#quantity_"+b).hide(),$("#selquantity_"+b).show(),$("#unit_"+b).text("轮播比例")):(d==CPM||d==CPC||d==CPF)&&($("#selquantity_"+b).hide(),$("#quantity_"+b).show(),$("#unit_"+b).text(d==CPC?"点击数":"展示数")),updateAdsData(b,"payMode",d),calAndSetCostMoney(b),daysChange(b),updateTotalCost()},window.salePriceChange=function(a){calAndSetCostMoney(a),updateTotalCost()},window.publishNumChange=function(a){calAndSetCostMoney(a),calAndSetPublishMoney(a),updateTotalCost(),updateAdsData(a,"publishQuantity",$("#quantity_"+a).val())},window.editPartialdate=function(a,b){var c=adsData["a"+b],d=_.template($("#j-select-time").html());$("#j-ad-date").modal("show").data("aId",b),$("#j-ad-date").find(".modal-body").html(d({title:c.title})),_.each(c.date,function(a,b){0==b&&$("#j-ad-date").find(".date-input-item").remove(),insertDateInput(a),$("#j-ad-date").find("#j-begin-date-0").closest(".date-input-item").find(".date-box-action").remove()})},$("#j-ad-date").on("click","#j-add-date",function(){insertDateInput({begin:"",end:""})}).on("click",".j-remove-date",function(){$(this).closest(".date-input-item").remove()}),$("#j-date-submit").on("click",function(){var a=$("#j-ad-date").find(".date-box-line").length,b=$("#j-ad-date").data("aId"),c=adsData["a"+b].date,d=[];_.each(c,function(a){"3"!=a.status&&d.push(a)});for(var e=0;a>e;e++)d.push({status:3,begin:moment($("#j-begin-date-"+e).val(),"YYYY-MM-DD").format("X"),end:moment($("#j-end-date-"+e).val(),"YYYY-MM-DD").format("X")});adsData["a"+b].date=d,$("#j-ad-date").modal("hide"),updateDate(adsData["a"+b],!0)}),window.saleguidecost=function(a){var b=$(a);""==b.val()&&b.val(0);var c=parseFloat(b.val());b.val(c.toFixed(2))},window.checkinput=function(a){var b=$(a);b.off("keypress").on("keypress",function(a){return console.log(a),46!=a.keyCode?a.keyCode>=46&&a.keyCode<=57:-1!=b.val().indexOf(".")?!1:void 0})},window.updateMediaPos=function(a){useTimestampUpdateDate();var b={jsonData:JSON.stringify(adsData),mediaPlanId:a},c="/adpublish/mediaPosition/update.do";$.ajax({url:c,type:"POST",async:!1,data:b,success:function(){},error:function(){alert("系统错误!")}})},window.showAds=function(a){var b="",c=0;for(var d in adsData)c++>0&&(b+=","),b+=adsData[d].aId;$("#select-ads-list").modal("show"),$("#selectPosFrame").attr("src","/media/adposition/selectPosList.do?type="+a+"&notInPosIds="+b)},window.confirmSelectAds=function(){var a=$("#selectPosFrame").contents().find("#selectPosData").val(),b=getNewSelectPosData(a);for(var c in b)c in adsData||(adsData[c]=b[c]);insertAds(adsData),$("#select-ads-list").modal("hide"),$("#selectPosFrame").contents().find(["id^='cb_'"]).removeAttr("checked"),$("#selectPosFrame").contents().find("#selectPosData").val("")}});