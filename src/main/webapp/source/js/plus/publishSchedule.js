define(function(a){function b(a){var b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=a.getMinutes();return b+"-"+(10>c?"0"+c:c)+"-"+(10>d?"0"+d:d)+" "+(10>e?"0"+e:e)+":"+(10>f?"0"+f:f)}function c(){p=new Date(r.getTime());var a=new Date(r.getTime());a.setMonth(a.getMonth()+2),q=new Date(a.getTime()-864e5),s("#CalendarLeft thead tr th").eq(1).html(getDate(p).substring(0,7)),s("#CalendarRight thead tr th").eq(0).html(getDate(q).substring(0,7))}function d(){var a=s("#CalendarLeft tbody tr").empty(),b=s("#CalendarRight tbody tr").empty(),c=-1,d=new Date(p.getTime()),e=d.getDay();e=0==e?7:e,d.setMonth(d.getMonth()+1);var f=new Date(d.getTime()-864e5).getDay();f=0==f?7:f,d=new Date(q.getTime());var g=d.getDay();g=0==g?7:g,d.setMonth(d.getMonth(),1);var i=new Date(d.getTime()),j=i.getDay();j=0==j?7:j;for(var k=0,l=0,m=0;42>m;m++){m%7==0&&c++;var n=new Date(p.getTime()+864e5*k);e-1>m||n.getMonth()>p.getMonth()?a.eq(c).append("<td class='null'>&nbsp;</td>"):(a.eq(c).append(h(1,1,n,0)),k++),n=new Date(i.getTime()+864e5*l),j-1>m||n.getMonth()>q.getMonth()?b.eq(c).append("<td class='null'>&nbsp;</td>"):(b.eq(c).append(h(1,1,n,0)),l++)}adspaceTimePartials.showPartail()}function e(){var a=s("#campaignId").val();s.getJSON("CampaignPartialDate.html?campaignId="+a+"&_t="+(new Date).getTime(),function(a){var b=new Date;b.setHours(0,0,0,0);for(var c=0;c<a.length;c++){var d=new Date(a[c].start.replace(new RegExp("-","gm"),"/")),e=new Date(a[c].end.replace(new RegExp("-","gm"),"/"));b>d&&(d=b),e>b&&adspaceTimePartials.addPartail(adspaceTimePartials.getSize(),new k(d,e))}if(adspaceTimePartials.isEmpty()){var f=b,g=new Date(b.getTime()+25056e5);g.setHours(23,59,0,0),adspaceTimePartials.addPartail(adspaceTimePartials.getSize(),new k(f,g))}adspaceTimePartials.showPartail()})}function f(a){for(var b in a){var c=new Date(a[b].start.replace(new RegExp("-","gm"),"/")),d=new Date(a[b].end.replace(new RegExp("-","gm"),"/")),e=new k(c,d);adspaceTimePartials.addPartail(adspaceTimePartials.getSize(),e)}adspaceTimePartials.showPartail()}function g(a){for(var b=s("#CalendarLeft tbody tr").empty(),c=s("#CalendarRight tbody tr").empty(),d=-1,e=0;e<a.length;e++){var f=new Date(a[e].date.replace(new RegExp("-","mg"),"/")),g=new Date(f.getTime()+864e5),i=f.getDay();if(i=0==i?7:i,1==f.getDate()&&(d=0),1!=f.getDate()&&1==i&&d++,1==f.getDate())for(var j=0;i-1>j;j++)f.getMonth()==r.getMonth()?b.eq(d).append("<td class='null'>&nbsp;</td>"):c.eq(d).append("<td class='null'>&nbsp;</td>");if(f.getMonth()==r.getMonth()?b.eq(d).append(h(a[e].color,a[e].status,f)):c.eq(d).append(h(a[e].color,a[e].status,f)),1==g.getDate())for(var k=7*(5-d)+(7-i),j=0;k>j;j++)f.getMonth()==r.getMonth()?(7==b.eq(d).find("td").length&&d++,b.eq(d).append("<td class='null'>&nbsp;</td>"),7==b.eq(d).find("td").length&&d++):(7==c.eq(d).find("td").length&&d++,c.eq(d).append("<td class='null'>&nbsp;</td>"),7==c.eq(d).find("td").length&&d++,7==c.eq(d).find("td").length&&d++)}}function h(a,b,c){var d,e=new Date((new Date).setHours(0,0,0,0));d=1==a?"available":2==a?"allsell available":"somesell available";var f="";c.getTime()<e.getTime()&&d.indexOf("disabled")<0&&(d+=" disabled"),9==b&&(u=!1,f+=" noborder"),8==b&&(f+=" noborder");var g=s('<td class="'+d+'"><a><i class="glyphicon '+f+'"></i>'+c.getDate()+"</a></td>");if(g.data("date",c),!g.hasClass("null")&&!g.hasClass("disabled")&&!g.hasClass("allsell")&&(g.on("click",function(){if(!(g.hasClass("null")||g.hasClass("disabled")||g.hasClass("allsell"))){var a=s(this).data("date");a.setHours(0),a.setMinutes(0);var b=new Date(a);a.setHours(23),a.setMinutes(59);var c=new Date(a);s(this).hasClass("active")?adspaceTimePartials.Delete(new Date(b.getTime()-6e4),new Date(c.getTime()+6e4)):adspaceTimePartials.Add(b,c,6e4),adspaceTimePartials.showPartail()}}),g.hasClass("allsell")&&"3"==s("#txtToufangType").val())){var h=c;h.setHours(0),h.setMinutes(0);var i=new Date(h);h.setHours(23),h.setMinutes(59);var j=new Date(h);adspaceTimePartials.Delete(new Date(i.getTime()-6e4),new Date(j.getTime()+6e4)),g.children().children().addClass("noborder")}return g}function i(){r=new Date(new Date(p.getTime()-864e5)),r.setMonth(r.getMonth(),1),c(),renderCalendar(),"Y"!=s("#editFlag").val()&&setDateReadOnlyForPageturn()}function j(){r=new Date(new Date(q.getTime()+864e5)),r.setMonth(r.getMonth()-1,1),c(),renderCalendar(),"Y"!=s("#editFlag").val()&&setDateReadOnlyForPageturn()}function k(a,b){this.edit(a,b)}function l(){this.partials=new Array,this.current=-1}function m(a){v=s(a);var b=v.parent().prev().prev().prev().html(),c=v.parent().prev().prev().html(),d=new Date(b.replace(new RegExp("-","mg"),"/")),e=new Date(c.replace(new RegExp("-","mg"),"/")),f=new k(d,e);adspaceTimePartials.deletePartail(adspaceTimePartials.indexOf(f)),adspaceTimePartials.showPartail()}function n(a){s("#j-DateView tbody td").each(function(){if(!s(this).hasClass("disabled")&&!s(this).hasClass("null")){var b=s(this).data("date");b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0);var c=new Date(b);b.setHours(23),b.setMinutes(59),b.setSeconds(0),b.setMilliseconds(0);var d=new Date(b);!s(a).prop("checked")||s(this).hasClass("allsell")&&"3"==s("#txtToufangType").val()&&s(this).children().children().hasClass("noborder")?adspaceTimePartials.Delete(new Date(c.getTime()-6e4),new Date(d.getTime()+6e4)):adspaceTimePartials.Add(c,d,6e4)}}),adspaceTimePartials.showPartail()}function o(a){var c=s(a.target),d=c.hasClass("set-partialdate"),e=c.offset(),f=e.top+c.height()+10,g=e.left+c.width()/2,h=new Date,i=getDate(h),j=s("#id-date-range-picker-1");moment().startOf("minute"),h.setHours(23),h.setMinutes(59);var l=b(new Date(h));if(d&&(i=c.parent().prev().prev().prev().html(),l=c.parent().prev().prev().html(),w=new Date(i.replace(new RegExp("-","mg"),"/")),x=new Date(l.replace(new RegExp("-","mg"),"/"))),s(".daterangepicker").remove(),j.removeData("daterangepicker"),j.daterangepicker({format:"YYYY-MM-DD HH:mm",separator:"~",startDate:i,endDate:l,minDate:b(new Date),showDropdowns:!0,timePicker:!0,timePickerIncrement:1,timePicker12Hour:!1,applyClass:"btn btn-small btn-success",locale:{applyLabel:"确定",cancelLabel:"取消",fromLabel:"开始时间",toLabel:"结束时间",customRangeLabel:"Custom Range",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],firstDay:1}},function(a,b){if(d){var c=new k(w,x);adspaceTimePartials.deletePartail(adspaceTimePartials.indexOf(c))}adspaceTimePartials.Add(new Date(a),new Date(b),6e4),adspaceTimePartials.showPartail()}),d){var m=new Date;if(m.setHours(0,0,0,0),w.getTime()<m.getTime()){var n=s("#id-date-range-picker-1").data("daterangepicker");s(".calendar.left").off("click","td.available",s.proxy(n.clickDate,n)),s(".calendar.left select").prop("disabled","disabled")}}var o=s(".daterangepicker");o.css({left:g,top:f}).show(),j.off("cancel.daterangepicker").on("cancel.daterangepicker",function(){o.hide()}),j.off("apply.daterangepicker").on("apply.daterangepicker",function(a,b){if(d){var c=new k(w,x);adspaceTimePartials.deletePartail(adspaceTimePartials.indexOf(c))}adspaceTimePartials.Add(new Date(b.startDate.format("YYYY-MM-DD HH:mm")),new Date(b.endDate.format("YYYY-MM-DD HH:mm")),6e4),adspaceTimePartials.showPartail(),o.hide()})}var p,q,r,s=a("$"),t=1;window.adspaceTimePartials=new l,window.setDateReadOnlyForPageturn=function(){s("#j-DateView tbody td").addClass("disabled"),s("#j-DateView tbody td").addClass("null"),s("a[name='date_setPartialdate']").remove(),s("a[name='date_delPartialdate']").remove(),s("#date_addPartialdateDiv").remove(),s("#date_selectallCheckbox").attr("disabled",!0)};var u=!0;window.getDate=function(a){var b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate();return b+"-"+(10>c?"0"+c:c)+"-"+(10>d?"0"+d:d)},window.getDateTime=function(a){var b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds();return b+"-"+(10>c?"0"+c:c)+"-"+(10>d?"0"+d:d)+" "+(10>e?"0"+e:e)+":"+(10>f?"0"+f:f)+":"+(10>g?"0"+g:g)},window.renderCalendar=function(){void 0==p&&void 0==q&&void 0==r&&(r=new Date,r.setMonth(r.getMonth(),1),c()),s.ajaxSettings.async=!1,s.getJSON("/adpublish/publishScheduling/getPublishScheduleJson.do",{start:getDate(p),end:getDate(q),isFirst:t,_t:(new Date).getTime(),eqPublishId:s("#publishId").val(),publishPosIds:getPublishPosIds()},function(a){if(a.block.length>0){var b=a.block[0];g(b.scheduleblock.adspacecolor),f(b.scheduleblock.partialdate),t&&0==b.scheduleblock.partialdate.length&&e()}else d();t=0,s("#selectall-checkbox").prop("checked",!1)})},window.prevMonth=i,window.nextMonth=j,k.prototype.edit=function(a,b){if(!(b>a))throw new Error("Error:start time later than end time.");this.Start=a,this.End=b},k.prototype.toString=function(){return b(this.Start)+"~"+b(this.End)},k.prototype.getDays=function(){var a=new Date(this.Start),b=new Date(this.End);return a.setHours(0,0,0,0),b.setHours(23,59,59,999),Math.ceil((b.getTime()-a.getTime())/864e5)},l.prototype.getSize=function(){return this.partials.length},l.prototype.hasNext=function(){return void 0!=this.partials[this.current+1]},l.prototype.moveNext=function(){return void 0!=this.partials[this.current+1]?(this.current++,!0):!1},l.prototype.movePrev=function(){return this.current>=0?(this.current--,!0):!1},l.prototype.moveToFirst=function(){this.current=0},l.prototype.moveToLast=function(){this.current=this.partials.length-1},l.prototype.isEmpty=function(){return 0==this.partials.length},l.prototype.getCurrent=function(){return this.partials[this.current]},l.prototype.Add=function(a,b,c){c=c||0;var d=!1,e=!1;if(a.setSeconds(0),a.setMilliseconds(0),0==b.getHours()&&0==b.getMinutes()&&(b=new Date(b.getTime()-6e4)),b.setSeconds(0),b.setMilliseconds(0),this.isEmpty())try{return this.addPartail(0,new k(a,b)),!0}catch(f){return!1}this.moveToFirst();do{var g=this.getCurrent();if(d||!y.lt(a,g.Start,c)&&!y.le(a,g.End,c)||(d=new Date(Math.min(a,g.Start))),y.lt(b,g.Start,c)){e=b;break}if(y.le(b,g.End,c)){e=new Date(Math.max(b,g.End)),this.deleteCurrentPartail();break}if(d&&(this.deleteCurrentPartail(),this.movePrev()),!this.hasNext()){d=d?d:a,e=b,this.current++;break}}while(this.moveNext());try{return this.addPartail(this.current,new k(d,e)),!0}catch(f){return!1}},l.prototype.addPartail=function(a,b){var c=!1;return s(this.partials).each(function(){this.toString()==b.toString()&&(c=!0)}),c?!1:(this.partials.splice(a,0,b),!0)},l.prototype.getDays=function(){for(var a=0,b=0;b<this.partials.length;b++)a+=this.partials[b].getDays();return a},l.prototype.deleteCurrentPartail=function(){this.deletePartail(this.current)},l.prototype.deletePartail=function(a){this.partials.splice(a,1)},l.prototype.Delete=function(a,b){if(a.setSeconds(0),a.setMilliseconds(0),b.setSeconds(0),b.setMilliseconds(0),!this.isEmpty()){this.moveToFirst();do{var c=this.getCurrent();if(b>=c.Start)if(a<=c.Start){if(b<c.End){c.edit(b,c.End);break}this.deleteCurrentPartail(),this.movePrev()}else if(a<c.End){if(b<c.End){var d=new k(b,new Date(c.End));c.edit(c.Start,a),this.addPartail(this.current+1,d);break}c.edit(c.Start,a)}}while(this.moveNext())}},l.prototype.showPartail=function(){s("#j-TimeView table tbody").empty();var a=0,c=new Date;c.setHours(0,0,0,0);for(var d=0;d<this.partials.length;d++){var e=this.partials[d].getDays(),f="<tr><td>"+b(this.partials[d].Start)+"</td><td>"+b(this.partials[d].End)+"</td><td>共"+e+"天</td><td>"+(this.partials[d].End.getTime()>=c.getTime()?'<a name="date_setPartialdate" class="j-setPartialdate set-partialdate" href="javascript:void(0)">编辑</a>':"")+(this.partials[d].Start.getTime()>=c.getTime()?'<a name="date_delPartialdate" href="javascript:void(0)" onclick="delPartialdate(this)">删除</a></td>':"");s("#j-TimeView table tbody").append(f),a+=e}s("#allDays").html("共"+a+"天");var g=this;s("#j-DateView tbody td").each(function(){if(!s(this).hasClass("null")){var a=s(this).data("date");a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);var b=new Date(a);a.setHours(23),a.setMinutes(59),a.setSeconds(0),a.setMilliseconds(0);var c=new Date(a),d=new Date,e=d>c?2:1;if(!g.isEmpty()){g.moveToFirst();do{var f=g.getCurrent();if(y.gt(f.Start,b,0)&&y.le(f.Start,c,0)||y.ge(f.End,b,0)&&y.lt(f.End,c,6e4)){e=d>c?6:5;break}if(y.le(f.Start,b,6e4)&&y.ge(f.End,c,6e4)){e=d>c?4:3;break}}while(g.moveNext())}s(this).children().children().removeClass("glyphicon-ok").removeClass("glyphicon-exclamation-sign"),s(this).removeClass("active"),3==e||4==e?(s(this).children().children().removeClass("glyphicon-ok").addClass("glyphicon-ok"),s(this).removeClass("active").addClass("active"),!s(this).hasClass("allsell")||"3"!=s("#txtToufangType").val()||u&&!s(this).children().children().hasClass("noborder")||s(this).children().children().removeClass("glyphicon-exclamation-sign").addClass("glyphicon-exclamation-sign")):(5==e||6==e)&&(s(this).children().children().removeClass("glyphicon-ok").addClass("glyphicon-ok"),s(this).removeClass("active").addClass("active"),!s(this).hasClass("allsell")||"3"!=s("#txtToufangType").val()||u&&!s(this).children().children().hasClass("noborder")||s(this).children().children().removeClass("glyphicon-exclamation-sign").addClass("glyphicon-exclamation-sign"))}})},l.prototype.indexOf=function(a){var b=-1;this.moveToFirst();do{var c=this.getCurrent();if(y.eq(c.Start,a.Start,0)&&y.eq(c.End,a.End,0)){b=this.current;break}}while(this.moveNext());return b};var v,w,x,y={eq:function(a,b,c){return Math.abs(a-b)<=c},lt:function(a,b,c){return b>a&&Math.abs(a-b)>c},le:function(a,b,c){return this.eq(a,b,c)||this.lt(a,b,c)},gt:function(a,b,c){return a>b&&Math.abs(a-b)>c},ge:function(a,b,c){return this.eq(a,b,c)||this.gt(a,b,c)}};window.delPartialdate=m,window.selectAllDate=n,s("#j-TimeView").on("click",".j-setPartialdate",function(a){o(a)}),renderCalendar()});